package lscolors

import (
	"os"
	"strings"
	"testing"
)

var benchLS *LSColors

func init() {
	ls, err := NewLSColors()
	if err != nil {
		panic(err)
	}
	benchLS = ls
}

func TestParseLSColors(t *testing.T) {
	colors := []string{
		"bd=0;38;2;138;190;183;48;2;51;51;51",
		"cd=0;38;2;178;148;187;48;2;51;51;51",
		"di=0;38;2;129;162;190",
		"ex=1;38;2;204;102;102",
		"fi=0",
		"ln=0;38;2;178;148;187",
		"mi=0;38;2;29;31;33;48;2;204;102;102",
		"or=0;38;2;29;31;33;48;2;204;102;102",
		"pi=0;38;2;29;31;33;48;2;129;162;190",
		"so=0;38;2;29;31;33;48;2;178;148;187",

		// Exts
		"*.c=0;38;2;181;189;104",
		"*.cc=0;38;2;181;189;104",
		"*.md=0;38;2;240;198;116",
		"*README.md=0;38;2;21;23;24;48;2;240;198;116",
	}
	ls, err := ParseLSColors(strings.Join(colors, ":"))
	if err != nil {
		t.Fatal(err)
	}

	tests := []struct {
		ext *ColorExtension
		seq string
	}{
		{&ls.BD, "0;38;2;138;190;183;48;2;51;51;51"},
		{&ls.CD, "0;38;2;178;148;187;48;2;51;51;51"},
		{&ls.DI, "0;38;2;129;162;190"},
		{&ls.EX, "1;38;2;204;102;102"},
		{&ls.FI, "0"},
		{&ls.LN, "0;38;2;178;148;187"},
		{&ls.MI, "0;38;2;29;31;33;48;2;204;102;102"},
		{&ls.OR, "0;38;2;29;31;33;48;2;204;102;102"},
		{&ls.PI, "0;38;2;29;31;33;48;2;129;162;190"},
		{&ls.SO, "0;38;2;29;31;33;48;2;178;148;187"},
	}
	for _, x := range tests {
		if x.ext.Seq != x.seq {
			t.Errorf("%s = %q; want: %q", x.ext.Ext, x.ext.Seq, x.seq)
		}
	}

	lookupExt := func(ext string) *ColorExtension {
		ext = strings.TrimPrefix(ext, "*")
		for i, e := range ls.Exts {
			if e.Ext == ext {
				return &ls.Exts[i]
			}
		}
		return nil
	}

	exts := map[string]string{
		"*.c":        "0;38;2;181;189;104",
		"*.cc":       "0;38;2;181;189;104",
		"*.md":       "0;38;2;240;198;116",
		"*README.md": "0;38;2;21;23;24;48;2;240;198;116",
	}
	for ext, seq := range exts {
		e := lookupExt(ext)
		if e == nil {
			t.Errorf("Missing ext: %q", ext)
			continue
		}
		if e.Seq != seq {
			t.Errorf("Ext %q = %q; want: %q", ext, e.Seq, seq)
		}
	}
}

func TestParseLSColorsStringAllocs(t *testing.T) {
	ls, err := ParseLSColors(strings.Join(hugeLSCOLOR, ":"))
	if err != nil {
		t.Fatal(err)
	}
	allocs := testing.AllocsPerRun(10, func() {
		_ = ls.String()
	})
	if allocs > 1.0 {
		t.Errorf("allocs = %f; want: 1'", allocs)
	}
}

func TestMatchExt(t *testing.T) {
	// Order random to make sure we pick the right one
	colors := []string{
		"*aaa=0;3",
		"*aaaa=0;4",
		"*aaaaa=0;5",
		"*aa=0;2",
		"*a=0;1",
	}
	ls, err := ParseLSColors(strings.Join(colors, ":"))
	if err != nil {
		t.Fatal(err)
	}
	e := ls.matchExt("README.aaaaa")
	if e == nil {
		t.Fatal("nil result")
	}
	if e.Seq != "0;5" {
		t.Fatal("WAT")
	}
}

func BenchmarkMatchExt(b *testing.B) {
	const name = "foo.README"
	// const name = "f.c"
	// const name = "old_CONTRIBUTORS.txt"
	ls := benchLS
	for i := 0; i < b.N; i++ {
		if ls.matchExt(name) == nil {
			b.Fatal("failed to find:", name)
		}
	}
}

func BenchmarkNewLSColors(b *testing.B) {
	clrs, ok := os.LookupEnv("LS_COLORS")
	if !ok {
		b.Fatal("ls_colors: LS_COLORS not set")
	}
	b.SetBytes(int64(len(clrs)))
	for i := 0; i < b.N; i++ {
		ls, err := ParseLSColors(clrs)
		if err != nil {
			b.Fatal(err)
		}
		_ = ls
	}
}

func BenchmarkLSColorsString(b *testing.B) {
	for i := 0; i < b.N; i++ {
		_ = benchLS.String()
	}
}

// Copy of my enormous LS_COLORS (generated with the excellent github.com/sharkdp/vivid)
var hugeLSCOLOR = []string{
	"bd=0;38;2;138;190;183;48;2;51;51;51",
	"cd=0;38;2;178;148;187;48;2;51;51;51",
	"di=0;38;2;129;162;190",
	"ex=1;38;2;204;102;102",
	"fi=0",
	"ln=0;38;2;178;148;187",
	"mi=0;38;2;29;31;33;48;2;204;102;102",
	"no=0",
	"or=0;38;2;29;31;33;48;2;204;102;102",
	"ow=0",
	"pi=0;38;2;29;31;33;48;2;129;162;190",
	"so=0;38;2;29;31;33;48;2;178;148;187",
	"st=0",
	"tw=0",
	// Exts
	"*.7z=4;38;2;138;190;183",
	"*.a=1;38;2;204;102;102",
	"*.aif=0;38;2;178;148;187",
	"*.apk=4;38;2;138;190;183",
	"*.applescript=0;38;2;181;189;104",
	"*.arj=4;38;2;138;190;183",
	"*.as=0;38;2;181;189;104",
	"*.asa=0;38;2;181;189;104",
	"*.aux=0;38;2;102;102;102",
	"*.avi=0;38;2;178;148;187",
	"*.awk=0;38;2;181;189;104",
	"*.bag=4;38;2;138;190;183",
	"*.bak=0;38;2;102;102;102",
	"*.bash=0;38;2;181;189;104",
	"*.bat=1;38;2;204;102;102",
	"*.bbl=0;38;2;102;102;102",
	"*.bc=0;38;2;102;102;102",
	"*.bcf=0;38;2;102;102;102",
	"*.bib=0;38;2;240;198;116",
	"*.bin=4;38;2;138;190;183",
	"*.blg=0;38;2;102;102;102",
	"*.bmp=0;38;2;178;148;187",
	"*.bsh=0;38;2;181;189;104",
	"*.bst=0;38;2;240;198;116",
	"*.bz2=4;38;2;138;190;183",
	"*.bz=4;38;2;138;190;183",
	"*.c++=0;38;2;181;189;104",
	"*.c=0;38;2;181;189;104",
	"*.cabal=0;38;2;181;189;104",
	"*.cache=0;38;2;102;102;102",
	"*.cc=0;38;2;181;189;104",
	"*.cfg=0;38;2;240;198;116",
	"*.CFUserTextEncoding=0;38;2;102;102;102",
	"*.cgi=0;38;2;181;189;104",
	"*.clang-format=0;38;2;181;189;104",
	"*.class=0;38;2;102;102;102",
	"*.clj=0;38;2;181;189;104",
	"*.cmake.in=0;38;2;181;189;104",
	"*.cmake=0;38;2;181;189;104",
	"*.com=1;38;2;204;102;102",
	"*.conf=0;38;2;240;198;116",
	"*.config=0;38;2;240;198;116",
	"*.cp=0;38;2;181;189;104",
	"*.cpp=0;38;2;181;189;104",
	"*.cr=0;38;2;181;189;104",
	"*.cs=0;38;2;181;189;104",
	"*.csv=0;38;2;240;198;116",
	"*.csx=0;38;2;181;189;104",
	"*.cxx=0;38;2;181;189;104",
	"*.d=0;38;2;181;189;104",
	"*.dart=0;38;2;181;189;104",
	"*.deb=4;38;2;138;190;183",
	"*.def=0;38;2;181;189;104",
	"*.desktop=0;38;2;240;198;116",
	"*.di=0;38;2;181;189;104",
	"*.diff=0;38;2;181;189;104",
	"*.dll=1;38;2;204;102;102",
	"*.dmg=4;38;2;138;190;183",
	"*.doc=0;38;2;204;102;102",
	"*.docx=0;38;2;204;102;102",
	"*.dot=0;38;2;181;189;104",
	"*.dox=0;38;2;181;189;104",
	"*.dpr=0;38;2;181;189;104",
	"*.DS_Store=0;38;2;102;102;102",
	"*.dyn_hi=0;38;2;102;102;102",
	"*.dyn_o=0;38;2;102;102;102",
	"*.el=0;38;2;181;189;104",
	"*.elm=0;38;2;181;189;104",
	"*.epp=0;38;2;181;189;104",
	"*.eps=0;38;2;178;148;187",
	"*.epub=0;38;2;204;102;102",
	"*.erl=0;38;2;181;189;104",
	"*.ex=0;38;2;181;189;104",
	"*.exe=1;38;2;204;102;102",
	"*.exs=0;38;2;181;189;104",
	"*.fdb_latexmk=0;38;2;102;102;102",
	"*.fdignore=0;38;2;181;189;104",
	"*.fish=0;38;2;181;189;104",
	"*.flac=0;38;2;178;148;187",
	"*.flake8=0;38;2;181;189;104",
	"*.fls=0;38;2;102;102;102",
	"*.flv=0;38;2;178;148;187",
	"*.fnt=0;38;2;178;148;187",
	"*.fon=0;38;2;178;148;187",
	"*.fs=0;38;2;181;189;104",
	"*.fsi=0;38;2;181;189;104",
	"*.fsx=0;38;2;181;189;104",
	"*.gemspec=0;38;2;181;189;104",
	"*.gif=0;38;2;178;148;187",
	"*.git=0;38;2;102;102;102",
	"*.gitattributes=0;38;2;181;189;104",
	"*.gitconfig=0;38;2;181;189;104",
	"*.gitignore=0;38;2;181;189;104",
	"*.gitmodules=0;38;2;181;189;104",
	"*.go=0;38;2;181;189;104",
	"*.gradle=0;38;2;181;189;104",
	"*.groovy=0;38;2;181;189;104",
	"*.gv=0;38;2;181;189;104",
	"*.gvy=0;38;2;181;189;104",
	"*.gz=4;38;2;138;190;183",
	"*.h++=0;38;2;181;189;104",
	"*.h264=0;38;2;178;148;187",
	"*.h=0;38;2;181;189;104",
	"*.hgrc=0;38;2;181;189;104",
	"*.hh=0;38;2;181;189;104",
	"*.hi=0;38;2;102;102;102",
	"*.hpp=0;38;2;181;189;104",
	"*.hs=0;38;2;181;189;104",
	"*.htc=0;38;2;181;189;104",
	"*.htm=0;38;2;240;198;116",
	"*.html=0;38;2;240;198;116",
	"*.hxx=0;38;2;181;189;104",
	"*.ico=0;38;2;178;148;187",
	"*.ics=0;38;2;204;102;102",
	"*.idx=0;38;2;102;102;102",
	"*.ignore=0;38;2;181;189;104",
	"*.ilg=0;38;2;102;102;102",
	"*.img=4;38;2;138;190;183",
	"*.inc=0;38;2;181;189;104",
	"*.ind=0;38;2;102;102;102",
	"*.ini=0;38;2;240;198;116",
	"*.inl=0;38;2;181;189;104",
	"*.ipp=0;38;2;181;189;104",
	"*.ipynb=0;38;2;181;189;104",
	"*.iso=4;38;2;138;190;183",
	"*.jar=4;38;2;138;190;183",
	"*.java=0;38;2;181;189;104",
	"*.jl=0;38;2;181;189;104",
	"*.jpeg=0;38;2;178;148;187",
	"*.jpg=0;38;2;178;148;187",
	"*.js=0;38;2;181;189;104",
	"*.json=0;38;2;240;198;116",
	"*.kdevelop=0;38;2;181;189;104",
	"*.kex=0;38;2;204;102;102",
	"*.ko=1;38;2;204;102;102",
	"*.kt=0;38;2;181;189;104",
	"*.kts=0;38;2;181;189;104",
	"*.la=0;38;2;102;102;102",
	"*.less=0;38;2;181;189;104",
	"*.lisp=0;38;2;181;189;104",
	"*.ll=0;38;2;181;189;104",
	"*.lo=0;38;2;102;102;102",
	"*.localized=0;38;2;102;102;102",
	"*.lock=0;38;2;102;102;102",
	"*.log=0;38;2;102;102;102",
	"*.ltx=0;38;2;181;189;104",
	"*.lua=0;38;2;181;189;104",
	"*.m4a=0;38;2;178;148;187",
	"*.m4v=0;38;2;178;148;187",
	"*.m=0;38;2;181;189;104",
	"*.make=0;38;2;181;189;104",
	"*.markdown=0;38;2;240;198;116",
	"*.matlab=0;38;2;181;189;104",
	"*.md=0;38;2;240;198;116",
	"*.mdown=0;38;2;240;198;116",
	"*.mid=0;38;2;178;148;187",
	"*.mir=0;38;2;181;189;104",
	"*.mkv=0;38;2;178;148;187",
	"*.ml=0;38;2;181;189;104",
	"*.mli=0;38;2;181;189;104",
	"*.mn=0;38;2;181;189;104",
	"*.mov=0;38;2;178;148;187",
	"*.mp3=0;38;2;178;148;187",
	"*.mp4=0;38;2;178;148;187",
	"*.mpeg=0;38;2;178;148;187",
	"*.mpg=0;38;2;178;148;187",
	"*.nb=0;38;2;181;189;104",
	"*.nix=0;38;2;240;198;116",
	"*.o=0;38;2;102;102;102",
	"*.odp=0;38;2;204;102;102",
	"*.ods=0;38;2;204;102;102",
	"*.odt=0;38;2;204;102;102",
	"*.ogg=0;38;2;178;148;187",
	"*.orig=0;38;2;102;102;102",
	"*.otf=0;38;2;178;148;187",
	"*.out=0;38;2;102;102;102",
	"*.p=0;38;2;181;189;104",
	"*.pas=0;38;2;181;189;104",
	"*.patch=0;38;2;181;189;104",
	"*.pbm=0;38;2;178;148;187",
	"*.pdf=0;38;2;204;102;102",
	"*.pgm=0;38;2;178;148;187",
	"*.php=0;38;2;181;189;104",
	"*.pid=0;38;2;102;102;102",
	"*.pkg=4;38;2;138;190;183",
	"*.pl=0;38;2;181;189;104",
	"*.pm=0;38;2;181;189;104",
	"*.png=0;38;2;178;148;187",
	"*.pod=0;38;2;181;189;104",
	"*.pp=0;38;2;181;189;104",
	"*.ppm=0;38;2;178;148;187",
	"*.pps=0;38;2;204;102;102",
	"*.ppt=0;38;2;204;102;102",
	"*.pptx=0;38;2;204;102;102",
	"*.pro=0;38;2;181;189;104",
	"*.ps1=0;38;2;181;189;104",
	"*.ps=0;38;2;204;102;102",
	"*.psd1=0;38;2;181;189;104",
	"*.psd=0;38;2;178;148;187",
	"*.psm1=0;38;2;181;189;104",
	"*.purs=0;38;2;181;189;104",
	"*.py=0;38;2;181;189;104",
	"*.pyc=0;38;2;102;102;102",
	"*.r=0;38;2;181;189;104",
	"*.rar=4;38;2;138;190;183",
	"*.rb=0;38;2;181;189;104",
	"*.rgignore=0;38;2;181;189;104",
	"*.rlib=0;38;2;102;102;102",
	"*.rm=0;38;2;178;148;187",
	"*.rpm=4;38;2;138;190;183",
	"*.rs=0;38;2;181;189;104",
	"*.rst=0;38;2;240;198;116",
	"*.rtf=0;38;2;204;102;102",
	"*.sbt=0;38;2;181;189;104",
	"*.scala=0;38;2;181;189;104",
	"*.scons_opt=0;38;2;102;102;102",
	"*.sconsign.dblite=0;38;2;102;102;102",
	"*.sh=0;38;2;181;189;104",
	"*.shtml=0;38;2;240;198;116",
	"*.so=1;38;2;204;102;102",
	"*.sql=0;38;2;181;189;104",
	"*.sty=0;38;2;102;102;102",
	"*.svg=0;38;2;178;148;187",
	"*.swf=0;38;2;178;148;187",
	"*.swift=0;38;2;181;189;104",
	"*.swp=0;38;2;102;102;102",
	"*.sxi=0;38;2;204;102;102",
	"*.sxw=0;38;2;204;102;102",
	"*.synctex.gz=0;38;2;102;102;102",
	"*.t=0;38;2;181;189;104",
	"*.tar=4;38;2;138;190;183",
	"*.tbz2=4;38;2;138;190;183",
	"*.tbz=4;38;2;138;190;183",
	"*.tcl=0;38;2;181;189;104",
	"*.td=0;38;2;181;189;104",
	"*.tex=0;38;2;181;189;104",
	"*.tgz=4;38;2;138;190;183",
	"*.tif=0;38;2;178;148;187",
	"*.tiff=0;38;2;178;148;187",
	"*.tml=0;38;2;240;198;116",
	"*.tmp=0;38;2;102;102;102",
	"*.toast=4;38;2;138;190;183",
	"*.toc=0;38;2;102;102;102",
	"*.toml=0;38;2;240;198;116",
	"*.travis.yml=0;38;2;181;189;104",
	"*.ts=0;38;2;181;189;104",
	"*.tsx=0;38;2;181;189;104",
	"*.ttf=0;38;2;178;148;187",
	"*.txt=0;38;2;240;198;116",
	"*.ui=0;38;2;240;198;116",
	"*.vb=0;38;2;181;189;104",
	"*.vcd=4;38;2;138;190;183",
	"*.vim=0;38;2;181;189;104",
	"*.vob=0;38;2;178;148;187",
	"*.wav=0;38;2;178;148;187",
	"*.wma=0;38;2;178;148;187",
	"*.wmv=0;38;2;178;148;187",
	"*.xcf=0;38;2;178;148;187",
	"*.xhtml=0;38;2;240;198;116",
	"*.xlr=0;38;2;204;102;102",
	"*.xls=0;38;2;204;102;102",
	"*.xlsx=0;38;2;204;102;102",
	"*.xml=0;38;2;240;198;116",
	"*.xmp=0;38;2;240;198;116",
	"*.xz=4;38;2;138;190;183",
	"*.yaml=0;38;2;240;198;116",
	"*.yml=0;38;2;240;198;116",
	"*.z=4;38;2;138;190;183",
	"*.zip=4;38;2;138;190;183",
	"*.zsh=0;38;2;181;189;104",
	"*appveyor.yml=0;38;2;181;189;104",
	"*CMakeCache.txt=0;38;2;102;102;102",
	"*CMakeLists.txt=0;38;2;181;189;104",
	"*CODEOWNERS=0;38;2;181;189;104",
	"*configure.ac=0;38;2;181;189;104",
	"*configure=0;38;2;181;189;104",
	"*CONTRIBUTORS.md=0;38;2;21;23;24;48;2;240;198;116",
	"*CONTRIBUTORS.txt=0;38;2;21;23;24;48;2;240;198;116",
	"*CONTRIBUTORS=0;38;2;21;23;24;48;2;240;198;116",
	"*COPYING=0;38;2;153;153;153",
	"*COPYRIGHT=0;38;2;153;153;153",
	"*css=0;38;2;181;189;104",
	"*Dockerfile=0;38;2;240;198;116",
	"*Doxyfile=0;38;2;181;189;104",
	"*hgrc=0;38;2;181;189;104",
	"*INSTALL.md=0;38;2;21;23;24;48;2;240;198;116",
	"*INSTALL.txt=0;38;2;21;23;24;48;2;240;198;116",
	"*INSTALL=0;38;2;21;23;24;48;2;240;198;116",
	"*LICENSE-APACHE=0;38;2;153;153;153",
	"*LICENSE-MIT=0;38;2;153;153;153",
	"*LICENSE=0;38;2;153;153;153",
	"*Makefile.am=0;38;2;181;189;104",
	"*Makefile.in=0;38;2;102;102;102",
	"*Makefile=0;38;2;181;189;104",
	"*MANIFEST.in=0;38;2;181;189;104",
	"*package-lock.json=0;38;2;102;102;102",
	"*passwd=0;38;2;240;198;116",
	"*README.md=0;38;2;21;23;24;48;2;240;198;116",
	"*README.txt=0;38;2;21;23;24;48;2;240;198;116",
	"*README=0;38;2;21;23;24;48;2;240;198;116",
	"*requirements.txt=0;38;2;181;189;104",
	"*SConscript=0;38;2;181;189;104",
	"*SConstruct=0;38;2;181;189;104",
	"*setup.py=0;38;2;181;189;104",
	"*shadow=0;38;2;240;198;116",
	"*TODO.md=1",
	"*TODO.txt=1",
	"*TODO=1",
	"*~=0;38;2;102;102;102",
}
